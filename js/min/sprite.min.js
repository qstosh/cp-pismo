"use strict";function CpTilesetDefinition(t){this._cols=1,this._rows=1,Cp.initObject(this,Cp.extend(!0,{},this.constructor.DEFAULTS,t)),this._evm=new CpEventManager}function CpSprite(t){if(!(t instanceof CpTilesetDefinition))throw new TypeError;this._tilesetDef=t,this._initElement(),this._timeline=this._createTimeline()}function CpTicker(){this._tickerPlayCounter=0,this._animFrame={}}function CpTimeline(t){this._ticker=new CpTicker,this._duration=0,this._labels={},this._timeline={},this._playTime=0,t=t||{},this._onComplete=t.onComplete||Cp.noop,this._debug=t.debug}function CpTween(t,e,i){this._target=t,this._duration=e||0,this._vars=i||{},this._playTime=0,this._ticker=new CpTicker,this._oldCSS={}}function CpTweenCall(t,e,i,n){this._callback=e,this._delay=t||0,this._params=i,this._scope=n}function CpTweenDelay(t){this._delay=t||0}function CpSequenceCreator(t,e){this._timeline=t,this._spriteList=[],this._reversedSpriteList={},this._model=e}function CpTemplate(t){this._storedCallback=[];var e=this;Cp.each(t.prototype,function(t,i){this[t]=function(){return e._storedCallback.push({callback:i,arguments:arguments}),e}}.bind(this))}function CpSequenceTemplate(){return new CpTemplate(CpSequenceCreator)}function CpModel(t){this._name=t,this._sequences={},this._sprites={},this._mainElement=$("<div />").css({position:"absolute"}).attr("data-name",t).addClass("animation-wrapper"),this._scaleWrapper=$("<div />").css("width","0px"),this._mainElement.append(this._scaleWrapper),this._readyCount=0,this._baseContainerSize=0,this._parallelSequencesRules={},this._activeSequences={},this._evm=new CpEventManager,this._data={}}function CpExclusionMap(t){this._byItem=[],this._parseDef("all",[t],null)}CpTilesetDefinition.setBasepath=function(t){this._basepath=t},CpTilesetDefinition.prototype.setPath=function(t){this._path=t,this._image=new Image,this._image.src=this.getPath(),this._image.onload=this._notifyReady.bind(this),this._image.onerror=this._notifyReady.bind(this)},CpTilesetDefinition.prototype.getPath=function(){return this.constructor._basepath+this._path},CpTilesetDefinition.prototype.ready=function(t){this._ready?t():this._evm.on("ready",t)},CpTilesetDefinition.prototype._notifyReady=function(){this._evm.trigger("ready").off("ready")},CpTilesetDefinition.prototype.getImageSize=function(){return this._image&&this._image.complete?[this._image.width,this._image.height]:null},CpTilesetDefinition.prototype.setRepeat=function(t){this.repeat=t},CpTilesetDefinition.prototype.setFirstFrame=function(t){this.firstFrame=t},CpTilesetDefinition.prototype.getFirstFrame=function(){return this.firstFrame||0},CpTilesetDefinition.prototype.getRepeat=function(){return this.repeat},CpTilesetDefinition.prototype.setFrameRate=function(t){this._frameRate=t},CpTilesetDefinition.prototype.getFrameRate=function(){return this._frameRate},CpTilesetDefinition.prototype.setFrameCount=function(t){this._frameCount=t},CpTilesetDefinition.prototype.getFrameCount=function(){return this._frameCount||this._cols*this._rows},CpTilesetDefinition.prototype.setHeight=function(t){this._height=t},CpTilesetDefinition.prototype.getHeight=function(){return this._height},CpTilesetDefinition.prototype.setStaticOffsetX=function(t){this._staticOffsetX=t},CpTilesetDefinition.prototype.setStaticOffsetY=function(t){this._staticOffsetY=t},CpTilesetDefinition.prototype.getStaticOffset=function(){return{x:Cp.isNumber(this._staticOffsetX)?this._staticOffsetX+"px":this._staticOffsetX||0,y:Cp.isNumber(this._staticOffsetY)?this._staticOffsetY+"px":this._staticOffsetY||0}},CpTilesetDefinition.prototype.setTilesCount=function(t,e){Cp.isArray(t)&&(e=t[1],t=t[0]),this._cols=t,this._rows=e},CpTilesetDefinition.prototype.getColumnCount=function(){return this._cols},CpTilesetDefinition.prototype.getRowCount=function(){return this._rows},CpTilesetDefinition.prototype.getTileOffset=function(t){t=parseInt(t);var e=this._cols>1?100*(t%this._cols)/(this._cols-1):0,i=this._rows>1?100*Math.floor(t/this._cols)/(this._rows-1):0;return{x:e+"%",y:i+"%"}},CpLogger.create(CpSprite),CpSprite.prototype.duration=function(){return this._timeline.duration()},CpSprite.prototype.appendTo=function(t){this.constructor.logger.trace("Apending animation ",this," to ",t),$(t).append(this._mainElement)},CpSprite.prototype._initElement=function(){var t=this._mainElement=$("<div />"),e=this._tilesetDef,i=e.getTileOffset(e.getFirstFrame()),n=e.getStaticOffset();t.css({"background-image":"url("+e.getPath()+")","background-position":i.x+" "+i.y,"background-size":e.getColumnCount()+"00% "+e.getRowCount()+"00%",transform:"translateX(-50%) translate("+n.x+","+n.y+")",opacity:"0",position:"absolute",left:"0",top:"0"}),this._tilesetDef.ready(function(){var i=this._tilesetDef.getImageSize(),n=i[1]/e.getRowCount(),s=i[0]/e.getColumnCount(),o=this._tilesetDef.getHeight()/n;t.css({width:s*o,height:this._tilesetDef.getHeight()})}.bind(this))},CpSprite.prototype.css=function(t,e){this._mainElement.css(t,e)},CpSprite.prototype.show=function(){this._mainElement.css("opacity",1)},CpSprite.prototype.hide=function(){this._mainElement.css("opacity",0)},CpSprite.prototype.isVisible=function(){return 1==this._mainElement.css("opacity")},CpSprite.prototype.gotoFrame=function(t){var e=this._mainElement,i=this._tilesetDef,n=i.getTileOffset(i.getFirstFrame()+t);e.css({"background-position":n.x+" "+n.y})},CpSprite.prototype._createTimeline=function(){var t=new CpTimeline,e=this,i=this._tilesetDef.getFrameRate(),n=this._tilesetDef.getFrameCount();if(1==n)return t.call(function(){e.gotoFrame(0)}),t;for(var s=0;s<this._tilesetDef.getRepeat();++s)for(var o=0;n>o;++o)t.call(function(t){e.gotoFrame(t)},[o]),t.add(new CpTweenDelay(1/i));return t},CpSprite.prototype.play=function(t){this.gotoFrame(0),this._timeline.play(t)},CpSprite.prototype.stop=function(){this._timeline.stop()},CpSprite.prototype.pause=function(){this._timeline.pause()},CpSprite.prototype.playBackwards=function(){this._timeline.reverse(this._timeline.duration())},CpLogger.create(CpTicker),CpTicker._requestFrame=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}).bind(window),CpTicker._cancelFrame=(window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(t){window.clearTimeout(t)}).bind(window),CpTicker._lagThreshold=200,CpTicker.DEBUG_COUNTER=0,CpTicker.prototype.play=function(t,e){if(!Cp.isFunction(e))throw new TypeError;this.stop(),++CpTicker.DEBUG_COUNTER;var i=performance.now()*(this.constructor.SPEED_UP||1);if(this._animFrame[++this._tickerPlayCounter]=!0,0>t)throw new Error("Base is less than zero");return this._tick(e,this._tickerPlayCounter,i-(1e3*t||0),i,i),this},CpTicker.prototype.stop=function(){return Cp.each(this._animFrame,function(t,e){if(--CpTicker.DEBUG_COUNTER<0)throw new Error("Ticker killed too many times?");this.constructor._cancelFrame(e),delete this._animFrame[t]}.bind(this)),this},CpTicker.prototype.isTicking=function(){return Object.keys(this._animFrame).length>0},CpTicker.SPEED_UP=1,CpTicker.prototype._tick=function(t,e,i,n,s){var s=performance.now()*(this.constructor.SPEED_UP||1),o=s-n;if(0>o)throw new Error("Negative tick time");o>this.constructor._lagThreshold&&(i+=o-this.constructor._lagThreshold),t((s-i)/1e3,e),this._animFrame[e]&&(this._animFrame[e]=this.constructor._requestFrame(this._tick.bind(this,t,e,i,s)))},CpLogger.create(CpTimeline),CpTimeline.prototype._tickHandler=function(t){this._debug&&this.constructor.logger.error("Play time : ",this._playTime);var e=this._playTime;this._playTime=t,Cp.each(this._timeline,function(i,n){i=parseFloat(i),(i>e&&t>i||i==e)&&Cp.each(n,function(e,n){n.play(Math.max(t-i,0))}.bind(this))}.bind(this)),this._playTime>=this._duration&&(this._ticker.stop(),this._onComplete())},CpTimeline.prototype.play=function(t){if(Cp.isString(t)){if(void 0==this._labels[t])throw new Error("Label "+t+" is not defined");t=this._labels[t]}return this._ticker.stop(),Cp.isNull(t)&&(t=this._playTime),this._playTime=t||0,this._ticker.play(t||0,this._tickHandler.bind(this)),this},CpTimeline.prototype.isActive=function(){return this._ticker.isTicking()||this._endless},CpTimeline.prototype.endless=function(t){this._endless=t},CpTimeline.prototype.restart=function(){return this.play(0)},CpTimeline.prototype.stop=function(){return this._ticker.stop(),Cp.each(this._timeline,function(t,e){Cp.each(e,function(t,e){e.stop()})}.bind(this)),this._playTime=0,this},CpTimeline.prototype.pause=function(){return Cp.each(this._timeline,function(t,e){Cp.each(e,function(t,e){e.pause()})}.bind(this)),this._ticker.stop(),this},CpTimeline.prototype.paused=function(){return this},CpTimeline.prototype.add=function(t,e){return Cp.isString(e)&&(e=this._labels[e]),void 0===e&&(e=this._duration),this._timeline[e]=this._timeline[e]||[],t instanceof CpTweenDelay||this._timeline[e].push(t),this._duration=Math.max(this._duration,e+t.duration()),this},CpTimeline.prototype.duration=function(){return this._duration},CpTimeline.prototype.call=function(t,e,i,n){return this.add(new CpTweenCall(0,t,e,i),n)},CpTimeline.prototype.to=function(t,e,i,n){return this.add(new CpTween(t,e,i),n)},CpTimeline.prototype.set=function(t,e,i){return this.add(new CpTween(t,0,e),i)},CpTimeline.prototype.loop=function(){this._onComplete=function(){this.play(0)}.bind(this)},CpTimeline.prototype.addLabel=function(t,e){return this._labels[t]=e||this._duration,this},CpTimeline.prototype.resolveLabel=function(t){return this._labels[t]},CpTween.prototype._tickHandler=function(t){var e=t/this._duration;return this._playTime=t,e>1?(this._setState(1),void this._ticker.stop()):void this._setState(e)},CpTween.prototype._setState=function(t){var e={left:"px"};Cp.each(this._vars,function(i){var n=this._oldCSS[i]+t*(this._vars[i]-this._oldCSS[i]);$(this._target).css(i,n+(e[i]||""))}.bind(this))},CpTween.prototype.play=function(t){if(this._oldCSS={},Cp.each(this._vars,function(t){this._oldCSS[t]=parseInt($(this._target).css(t))}.bind(this)),Cp.isNull(t)&&(t=this._playTime),0>t)throw new Error("CpTween negative time in play");0==this._duration?this._setState(1):this._ticker.play(t,this._tickHandler.bind(this))},CpTween.prototype.stop=function(){this._playTime=0,this._ticker.stop()},CpTween.prototype.pause=function(){this._ticker.stop()},CpTween.prototype.duration=function(){return this._duration},CpTweenCall.prototype.play=function(){this._delay>0?(window.clearTimeout(this._timeout),this._timeout=window.setTimeout(function(){this._callback.apply(this._scope,this._params)}.bind(this),this._delay)):this._callback.apply(this._scope,this._params)},CpTweenCall.prototype.stop=function(){window.clearTimeout(this._timeout)},CpTweenCall.prototype.pause=function(){window.clearTimeout(this._timeout)},CpTweenCall.prototype.duration=function(){return this._delay},CpTweenDelay.prototype.play=function(){},CpTweenDelay.prototype.stop=function(){},CpTweenDelay.prototype.pause=function(){},CpTweenDelay.prototype.duration=function(){return this._delay},CpLogger.create(CpSequenceCreator),CpSequenceCreator.prototype.timeline=function(t){return t.call(this,this._timeline,this._spriteList),this},CpSequenceCreator.prototype.useSprites=function(){return Cp.each(arguments,function(t,e){if(Cp.isArray(e))this.useSprites.apply(this,e);else{var i=this._model.getSprite(e);if(!i)return void this.constructor.logger.fatal("Sprite ",e," does not exists");this._spriteList.push({name:e,sprite:i}),this._reversedSpriteList[e]=i}}.bind(this)),this},CpSequenceCreator.prototype.getUsedSprites=function(){return this._spriteList},CpSequenceCreator.prototype.call=function(t){return this._timeline.call(t,[this._timeline]),this},CpSequenceCreator.prototype.css=function(t,e){return this._timeline.set(this._spriteList[t].sprite._mainElement,e),this},CpSequenceCreator.prototype.delay=function(t){return this._timeline.add(new CpTweenDelay(t)),this},CpSequenceCreator.prototype.hide=function(t){return this.css(t,{opacity:0}),this},CpSequenceCreator.prototype.show=function(t){return this.css(t,{opacity:1}),this},CpSequenceCreator.prototype.cssWhilePlay=function(t,e){return this._timeline.to(this._spriteList[t].sprite._mainElement,this._spriteList[t].sprite._timeline.duration(),e,"sprite-begin-"+t),this},CpSequenceCreator.prototype.addLabel=function(t){return this._timeline.addLabel(t),this},CpSequenceCreator.prototype.jump=function(t){return this._timeline.call(function(){this._timeline.play(t)}.bind(this)),this},CpSequenceCreator.prototype.play=function(t){if(!this._spriteList[t])throw new Error("Sprite "+t+" is not defined");var e=this._model.getSpriteExclusionMap();return e&&Cp.each(e.getConflicting(this._spriteList[t].name),function(t,e){this._reversedSpriteList[e]&&this._timeline.set(this._reversedSpriteList[e]._mainElement,{opacity:0})}.bind(this)),this._timeline.addLabel("sprite-begin-"+t).set(this._spriteList[t].sprite._mainElement,{opacity:1}).add(this._spriteList[t].sprite),this},CpSequenceCreator.prototype.loop=function(){if(0===this._timeline.duration())throw new Error("Zero duration timeline loop");this._timeline.loop(0)},CpTemplate.prototype.applyToObject=function(t){Cp.each(this._storedCallback,function(e,i){i.callback.apply(t,i.arguments)})},CpLogger.create(CpModel),CpModel.prototype.ready=function(t){this._readyCount<=0?t():this._evm.on("ready",t)},CpModel.prototype._notifyReady=function(){this._evm.trigger("ready").off("ready");var t=this;$(window).on("resize",function(){var e=$(t._mainElement);e.css("transform","");var i=$(e).height()/t._baseContainerSize;t._scaleWrapper.css("transform","scale("+i+")")}).trigger("resize")},CpModel.prototype.appendTo=function(t){$(t).append(this._mainElement)},CpModel.prototype.getMainElement=function(){return this._mainElement},CpModel.prototype.setData=function(t,e){this._data[t]=e},CpModel.prototype.getData=function(t){return this._data[t]},CpModel.prototype.createSequence=function(t,e){if(this._sequences[t])throw new Error("Sequence is already defined");return this._sequences[t]={},this._sequences[t].timeline=new CpTimeline({debug:!1,onComplete:function(){this.constructor.logger.debug("Model "+this._name+" event : complete-"+t),this._evm.trigger("complete-"+t).off("complete-"+t)}.bind(this)}),this._sequences[t].creator=new CpSequenceCreator(this._sequences[t].timeline,this),e instanceof CpTemplate&&e.applyToObject(this._sequences[t].creator),this._sequences[t].creator},CpModel.prototype.createSimpleSequence=function(t,e){if(this._sequences[t])throw new Error("Sequence is already defined");void 0==e&&(e=t),this._sequences[t]={hide:Cp.noop,show:Cp.noop},this._sequences[t].timeline=new CpTimeline({onComplete:function(){this._evm.trigger("complete-"+t).off("complete-"+t)}.bind(this)}),this._sequences[t].creator=new CpSequenceCreator(this._sequences[t].timeline,this),this._sequences[t].creator.useSprites(e).play(0),this._sequences[t].timeline.endless(!0)},CpModel.prototype.playSequence=function(t,e){if(!t)return void Cp.each(this._activeSequences,function(t){this.playSequence(t,e)}.bind(this));var i=this._parallelSequencesRules[t]||[];Cp.each(this._activeSequences,function(e){var n=i.indexOf(e);-1===n&&e!=t&&(this._sequences[e].timeline.stop(),delete this._activeSequences[e],Cp.each(this._sequences[e].creator.getUsedSprites(),function(t,e){e.sprite.hide()}))}.bind(this)),this.getMainElement().show(),this._sequences[t]?(this.show(),this._sequences[t].timeline.play(e),this._evm.trigger("play-"+t),this._activeSequences[t]=!0):this.constructor.logger.fatal("Sequence "+t+" does not exists")},CpModel.prototype.stopSequence=function(t){return t?void(this._sequences[t]?(this._sequences[t].timeline.stop(),delete this._activeSequences[t],this._evm.trigger("complete-"+t).off("complete-"+t)):this.constructor.logger.fatal("Sequence "+t+" does not exists")):void Cp.each(this._activeSequences,function(t){this.stopSequence(t)}.bind(this))},CpModel.prototype.pause=function(t){return t?void(this._sequences[t]?(this._sequences[t].timeline.pause(),this._evm.trigger("complete-"+t).off("complete-"+t)):this.constructor.logger.fatal("Sequence "+t+" does not exists")):void Cp.each(this._activeSequences,function(t){this.pause(t)}.bind(this))},CpModel.prototype.isPlaying=function(t){return!0===this._activeSequences[t]&&this._sequences[t].timeline.isActive()},CpModel.prototype.isActive=function(t){return!0===this._activeSequences[t]},CpModel.prototype.onPlay=function(t,e){Cp.isArray(t)?Cp.each(t,function(t,i){this.onPlay(i,e)}.bind(this)):this._evm.on("play-"+t,e)},CpModel.prototype.show=function(){this._mainElement.css("opacity",1)},CpModel.prototype.hide=function(){Cp.each(this._activeSequences,function(t){Cp.each(this._sequences[t].creator.getUsedSprites(),function(t,e){e.sprite.hide()})}.bind(this)),this.stopSequence(),this._mainElement.css("opacity",0)},CpModel.prototype.completeSequence=function(t,e){return this._sequences[t]&&this._sequences[t].timeline.isActive()?(this.constructor.logger.debug("Model "+this._name+" waiting for complete-"+t),void this._evm.off("complete-"+t).on("complete-"+t,e)):(this.constructor.logger.debug("Model "+this._name+" sequence "+t+" is already complete"),(e||Cp.noop)(),this)},CpModel.prototype.setPosition=function(t){return this._mainElement.css("left",Cp.isNumber(t)?t+"%":t),this},CpModel.prototype.addSprites=function(t){return Cp.each(t,function(t,e){this.addSprite(t,e)}.bind(this)),this},CpModel.prototype.addSprite=function(t,e){e instanceof CpTilesetDefinition||(e=new CpTilesetDefinition(e)),this._sprites[t]=new CpSprite(e),this._sprites[t].appendTo(this._scaleWrapper),++this._readyCount,e.ready(function(){this._baseContainerSize=Math.max(this._baseContainerSize,e.getImageSize()[1]/e.getRowCount()),this._scaleWrapper.css("height",this._baseContainerSize),--this._readyCount,this._notifyReady()}.bind(this))},CpModel.prototype.getSprite=function(t){return this._sprites[t]},CpModel.prototype.allowParallelSequences=function(t,e){Cp.isArray(t)||(t=[t]),Cp.isArray(e)||(e=[e]),Cp.each(t,function(t,i){this._parallelSequencesRules[i]=this._parallelSequencesRules[i]||[],this._parallelSequencesRules[i]=this._parallelSequencesRules[i].concat(e)}.bind(this)),Cp.each(e,function(e,i){this._parallelSequencesRules[i]=this._parallelSequencesRules[i]||[],this._parallelSequencesRules[i]=this._parallelSequencesRules[i].concat(t)}.bind(this))},CpModel.prototype.setSpriteExclusionMap=function(t){this._spriteExclusionMap=new CpExclusionMap(t)},CpModel.prototype.getSpriteExclusionMap=function(){return this._spriteExclusionMap},CpExclusionMap.prototype._parseDef=function(t,e,i){var n={parent:i,siblings:[],rule:t};Cp.each(e,function(t,e){Cp.isObject(e)&&Cp.each(e,function(t,e){this._parseDef(t,e,n)}.bind(this)),n.siblings.push(e),Cp.isString(e)&&(this._byItem[e]=n)}.bind(this))},CpExclusionMap.prototype.getConflicting=function(t){var e=[];if(!this._byItem[t])return e;for(var i=this._byItem[t],n=null;null!==i;)"one"==i.rule&&this._pushRecursive(e,i.siblings,n),n=i,i=i.parent;var s=e.indexOf(t);return s>-1&&e.splice(s,1),e},CpExclusionMap.prototype._pushRecursive=function(t,e,i){Cp.each(e,function(n,s){e!=i&&(Cp.isString(s)?t.push(s):this._pushRecursive(t,s,null))}.bind(this))};